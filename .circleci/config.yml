version: 2.1
executors:
  node-browser:
    docker:
      - image: circleci/node:12.16.3-browsers
    working_directory: ~/weitzly

jobs:
  build:
    executor: node-browser
    steps:
      - add_ssh_keys:
          fingerprints:
            - '4e:fe:3f:a2:04:6d:60:d2:97:bc:d7:14:24:b0:1b:ab'
      # - run: ssh-keyscan $REMOTE_IP >> ~/.ssh/known_hosts
      - checkout
      - run:
          name: Code Has Arrived
          command: |
            ls -al
            echo '^^^That should look familiar^^^'
      - run: npm install
      - run: npm run test
      - run: npm run build
      - run: mkdir -p ~/weitzly/output
      - run: cp -avr html ~/weitzly/output/html
      # - store_artifacts:
      #     path: ~/weitzly/html
      - persist_to_workspace:
          root: output
          paths:
            - html/*
  deploy:
    executor: node-browser

    steps:
      - attach_workspace:
          at: ~/weitzly/output
      - add_ssh_keys:
          fingerprints:
            - '63:4a:86:b0:a4:a2:83:c8:8a:42:ef:0d:0c:dc:31:bb'
      - run: ssh-keyscan $REMOTE_IP >> ~/.ssh/known_hosts
      - run:
          name: Review files...
          command: |
            pwd
            cd ~/weitzly/output
            ls -al
            echo '^^^That should look familiar^^^'
      - run:
          name: Deploy Over SSH
          command: |
            { 
              scp -r ~/weitzly/output/html/* $FTP_USER@$REMOTE_IP:$REMOTE_PATH/$BUILD_PATH && scp_status=$?
              echo SCP returned with code $scp_status
              return 0;
            } || { 
              echo SCP returned with code $scp_status
              return 0;
            }

workflows:
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master # only deploy on the master branch
